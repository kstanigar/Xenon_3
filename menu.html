<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Nonex</title>
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      background: #000;
      color: #fff;
      font-family: Arial, sans-serif;
      overflow: hidden;
      width: 100vw;
      height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 36px;
    }

    /* ── Starfield ── */
    #starfield {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      z-index: 0;
      pointer-events: none;
    }

    /* ── Content wrapper ── */
    .menu-wrap {
      position: relative;
      z-index: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 36px;
    }

    /* ── Title ── */
    .title {
      font-size: clamp(52px, 12vw, 96px);
      font-weight: bold;
      letter-spacing: 14px;
      text-transform: uppercase;
      color: #00FFFF;
      text-shadow:
        0 0 18px #00FFFF,
        0 0 40px #00FFFF,
        0 0 80px rgba(0,255,255,0.4);
      animation: titlePulse 3s ease-in-out infinite;
    }

    @keyframes titlePulse {
      0%, 100% { text-shadow: 0 0 18px #00FFFF, 0 0 40px #00FFFF, 0 0 80px rgba(0,255,255,0.4); }
      50%       { text-shadow: 0 0 28px #00FFFF, 0 0 60px #00FFFF, 0 0 110px rgba(0,255,255,0.6); }
    }

    /* ── Platform buttons ── */
    .platform-group {
      display: flex;
      gap: 20px;
      flex-wrap: wrap;
      justify-content: center;
    }

    .platform-btn {
      width: 200px;
      padding: 18px 0;
      font-size: 17px;
      font-family: Arial, sans-serif;
      font-weight: bold;
      letter-spacing: 1px;
      border: 2px solid #444;
      background: transparent;
      color: #aaa;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
      line-height: 1.4;
    }

    .platform-btn span {
      display: block;
      font-size: 12px;
      font-weight: normal;
      letter-spacing: 0;
      color: #666;
      margin-top: 4px;
      transition: color 0.2s;
    }

    .platform-btn:hover,
    .platform-btn.selected {
      border-color: #00FFFF;
      color: #00FFFF;
      background: rgba(0,255,255,0.08);
      text-shadow: 0 0 8px #00FFFF;
      box-shadow: 0 0 16px rgba(0,255,255,0.25);
    }

    .platform-btn.selected span,
    .platform-btn:hover span {
      color: rgba(0,255,255,0.7);
    }

    /* ── Toggle rows ── */
    .toggles {
      display: flex;
      flex-direction: column;
      gap: 14px;
      align-items: stretch;
      width: 260px;
    }

    .toggle-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 14px 18px;
      border: 1px solid #2a2a2a;
      border-radius: 8px;
      background: rgba(255,255,255,0.03);
      cursor: pointer;
      transition: border-color 0.2s, background 0.2s;
      user-select: none;
    }

    .toggle-row:hover {
      border-color: #555;
      background: rgba(255,255,255,0.06);
    }

    .toggle-label {
      font-size: 15px;
      color: #ccc;
    }

    .toggle-label small {
      display: block;
      font-size: 11px;
      color: #555;
      margin-top: 2px;
    }

    /* Pill switch */
    .switch {
      position: relative;
      width: 46px;
      height: 26px;
      flex-shrink: 0;
    }

    .switch input { display: none; }

    .slider {
      position: absolute;
      inset: 0;
      border-radius: 26px;
      background: #333;
      transition: background 0.2s;
      cursor: pointer;
    }

    .slider::before {
      content: '';
      position: absolute;
      width: 20px; height: 20px;
      left: 3px; top: 3px;
      border-radius: 50%;
      background: #888;
      transition: transform 0.2s, background 0.2s;
    }

    input:checked + .slider { background: rgba(0,255,136,0.25); }
    input:checked + .slider::before {
      transform: translateX(20px);
      background: #00FF88;
      box-shadow: 0 0 8px #00FF88;
    }

    /* ── Play button ── */
    #playBtn {
      padding: 18px 80px;
      font-size: 20px;
      font-family: Arial, sans-serif;
      font-weight: bold;
      letter-spacing: 3px;
      text-transform: uppercase;
      background: #00FFFF;
      color: #000;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      box-shadow: 0 0 24px rgba(0,255,255,0.5);
      transition: all 0.2s;
    }

    #playBtn:hover {
      background: #fff;
      box-shadow: 0 0 40px rgba(0,255,255,0.9);
      transform: scale(1.04);
    }

    #playBtn:active {
      transform: scale(0.98);
    }
  </style>
</head>
<body>

  <canvas id="starfield"></canvas>

  <div class="menu-wrap">

    <div class="title">Nonex</div>

    <!-- Platform select -->
    <div class="platform-group">
      <button class="platform-btn selected" id="btnComputer" onclick="selectPlatform('computer')">
        Computer
        <span>4:3 display</span>
      </button>
      <button class="platform-btn" id="btnMobile" onclick="selectPlatform('mobile')">
        Mobile
        <span>19.5:9 display</span>
      </button>
    </div>

    <!-- Toggles -->
    <div class="toggles">

      <label class="toggle-row" for="musicSwitch">
        <div class="toggle-label">
          Music
          <small>Background music during gameplay</small>
        </div>
        <div class="switch">
          <input type="checkbox" id="musicSwitch" checked onchange="onMusicToggle()" />
          <div class="slider"></div>
        </div>
      </label>

      <label class="toggle-row" for="analyticsSwitch">
        <div class="toggle-label">
          Anonymous Data
          <small>Help improve the game — no personal info collected</small>
        </div>
        <div class="switch">
          <input type="checkbox" id="analyticsSwitch" onchange="onAnalyticsToggle()" />
          <div class="slider"></div>
        </div>
      </label>

    </div>

    <!-- Play -->
    <button id="playBtn" onclick="launchGame()">Play</button>

  </div>

  <script>
    // ── Starfield ────────────────────────────────────────────────────────
    (function () {
      var c = document.getElementById('starfield');
      var ctx = c.getContext('2d');
      var stars = [];
      var NUM_STARS = 160;

      function resize() {
        c.width = window.innerWidth;
        c.height = window.innerHeight;
      }

      function initStars() {
        stars = [];
        for (var i = 0; i < NUM_STARS; i++) {
          stars.push({
            x: Math.random() * c.width,
            y: Math.random() * c.height,
            r: Math.random() * 1.5 + 0.3,
            speed: Math.random() * 0.4 + 0.1,
            alpha: Math.random() * 0.6 + 0.3
          });
        }
      }

      function tick() {
        ctx.clearRect(0, 0, c.width, c.height);
        for (var i = 0; i < stars.length; i++) {
          var s = stars[i];
          s.y += s.speed;
          if (s.y > c.height) { s.y = 0; s.x = Math.random() * c.width; }
          ctx.beginPath();
          ctx.arc(s.x, s.y, s.r, 0, Math.PI * 2);
          ctx.fillStyle = 'rgba(255,255,255,' + s.alpha + ')';
          ctx.fill();
        }
        requestAnimationFrame(tick);
      }

      window.addEventListener('resize', function () { resize(); initStars(); });
      resize();
      initStars();
      tick();
    })();

    // ── Analytics ────────────────────────────────────────────────────────
    // Set ANALYTICS_ENDPOINT to your server URL to start receiving events.
    // Leave as '' to buffer locally in localStorage only.
    var ANALYTICS_ENDPOINT = '';

    function generateId() {
      return Date.now().toString(36) + Math.random().toString(36).slice(2, 8);
    }

    // One session ID per browser tab, persists until tab is closed
    var sessionId = sessionStorage.getItem('nonex_session');
    if (!sessionId) {
      sessionId = generateId();
      sessionStorage.setItem('nonex_session', sessionId);
    }

    function trackEvent(name, data) {
      // Always allow the consent-change event itself so we capture the opt-in moment.
      // All other events require analytics consent.
      var hasConsent = localStorage.getItem('nonex_analytics') === 'on';
      if (!hasConsent && name !== 'analytics_toggled') return;

      var event = {
        event:   name,
        session: sessionId,
        ts:      new Date().toISOString(),
        data:    data || {}
      };

      // Buffer in localStorage (useful for later batch-upload or debugging)
      try {
        var queue = JSON.parse(localStorage.getItem('nonex_event_queue') || '[]');
        queue.push(event);
        // Keep last 200 events to avoid unbounded growth
        if (queue.length > 200) queue = queue.slice(-200);
        localStorage.setItem('nonex_event_queue', JSON.stringify(queue));
      } catch (e) { /* storage full — skip buffering */ }

      // POST to endpoint if configured
      if (ANALYTICS_ENDPOINT) {
        fetch(ANALYTICS_ENDPOINT, {
          method:    'POST',
          headers:   { 'Content-Type': 'application/json' },
          body:      JSON.stringify(event),
          keepalive: true   // fires even if user navigates away
        }).catch(function () { /* silently ignore network errors */ });
      }
    }

    // ── Preferences ─────────────────────────────────────────────────────
    var selectedPlatform = 'computer';

    function selectPlatform(p) {
      var prev = selectedPlatform;
      selectedPlatform = p;
      document.getElementById('btnComputer').classList.toggle('selected', p === 'computer');
      document.getElementById('btnMobile').classList.toggle('selected', p === 'mobile');
      savePrefs();
      if (prev !== p) {
        trackEvent('platform_selected', { platform: p });
      }
    }

    function savePrefs() {
      localStorage.setItem('nonex_music',     document.getElementById('musicSwitch').checked     ? 'on' : 'off');
      localStorage.setItem('nonex_analytics', document.getElementById('analyticsSwitch').checked ? 'on' : 'off');
      localStorage.setItem('nonex_platform',  selectedPlatform);
    }

    function onMusicToggle() {
      var val = document.getElementById('musicSwitch').checked ? 'on' : 'off';
      savePrefs();
      trackEvent('music_toggled', { value: val });
    }

    function onAnalyticsToggle() {
      var val = document.getElementById('analyticsSwitch').checked ? 'on' : 'off';
      savePrefs();
      // trackEvent reads the updated localStorage value, so consent is already saved
      trackEvent('analytics_toggled', { value: val });
    }

    function loadPrefs() {
      var music     = localStorage.getItem('nonex_music');
      var analytics = localStorage.getItem('nonex_analytics');
      var platform  = localStorage.getItem('nonex_platform');

      if (music !== null)     document.getElementById('musicSwitch').checked     = (music === 'on');
      if (analytics !== null) document.getElementById('analyticsSwitch').checked = (analytics === 'on');
      if (platform)           selectPlatform(platform);
    }

    function launchGame() {
      savePrefs();
      trackEvent('play_clicked', {
        platform:  selectedPlatform,
        music:     localStorage.getItem('nonex_music'),
        analytics: localStorage.getItem('nonex_analytics')
      });
      var dest = selectedPlatform === 'mobile' ? '/Xenon_3/index_mobile.html' : '/Xenon_3/index.html';
      // Small delay so the fetch can fire before navigation
      setTimeout(function () { window.location.href = dest; }, ANALYTICS_ENDPOINT ? 120 : 0);
    }

    loadPrefs();
    trackEvent('menu_view', { referrer: document.referrer || 'direct' });
  </script>
</body>
</html>
